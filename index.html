// Department tracking
let visitedDepartments = new Set();
let currentHallway = 0;

function handleLoops(hallwayNumber) {
  // Mark the current department as visited
  visitedDepartments.add(hallwayNumber);
  currentHallway = hallwayNumber;
  
  // Check if all 3 departments have been completed
  if (visitedDepartments.size >= 3 && hallwayNumber === 3) {
    // All departments completed, exiting hallway 3 - show massive chamber
    showMassiveChamber();
  } else {
    // Hallways 1-2 or incomplete: teleport back to lobby
    teleportToLobby();
  }
}

function teleportToLobby() {
  // Reset player position to lobby (seamlessly)
  // This creates the illusion of a new lobby
  camera.position.set(0, STAND_Y, 0);
  yaw = 0;
  pitch = 0;
  vel.set(0, 0, 0);
  crouchToggle = false;
  crouchHold = false;
}

function showMassiveChamber(){
  const chamberH = 30.5;
  const chamberW = 20;
  const chamberD = 40;
  const chamberX = 0;
  const chamberZ = 150;
  const cy = chamberH / 2;
  
  // Floor
  floorPlane(chamberX, chamberZ, chamberW, chamberD, mat.offWhite);
  ceilPlane(chamberX, chamberZ, chamberW, chamberD, chamberH, mat.ceiling);
  
  // Side walls
  wallBox(chamberX - chamberW/2, cy, chamberZ, WALL_T, chamberH, chamberD, mat.offWhite);
  wallBox(chamberX + chamberW/2, cy, chamberZ, WALL_T, chamberH, chamberD, mat.offWhite);
  
  // Back wall (south)
  wallBox(chamberX, cy, chamberZ - chamberD/2, chamberW, chamberH, WALL_T, mat.offWhite);
  
  // North wall with door opening
  const northZ = chamberZ + chamberD/2;
  const doorW = 1.2;
  const doorH = 1.8;
  const wallSegLeft = (chamberW/2) - (doorW/2);
  const wallSegRight = (chamberW/2) - (doorW/2);
  wallBox(chamberX - chamberW/2 + wallSegLeft/2, cy, northZ, wallSegLeft, chamberH, WALL_T, mat.offWhite);
  wallBox(chamberX + chamberW/2 - wallSegRight/2, cy, northZ, wallSegRight, chamberH, WALL_T, mat.offWhite);
  
  // Massive glowing RB logo
  const logoCanvas = document.createElement('canvas');
  logoCanvas.width = 2048;
  logoCanvas.height = 1024;
  const logoCtx = logoCanvas.getContext('2d');
  logoCtx.fillStyle = 'rgba(42, 36, 29, 1)';
  logoCtx.fillRect(0, 0, logoCanvas.width, logoCanvas.height);
  logoCtx.fillStyle = '#dc4d3c';
  logoCtx.font = 'bold 600px Arial';
  logoCtx.textAlign = 'center';
  logoCtx.textBaseline = 'middle';
  logoCtx.fillText('RB', logoCanvas.width/2, logoCanvas.height/2);
  
  const logoTex = new THREE.CanvasTexture(logoCanvas);
  logoTex.colorSpace = THREE.SRGBColorSpace;
  logoTex.needsUpdate = true;
  
  const logoMat = new THREE.MeshStandardMaterial({
    map: logoTex,
    roughness: 0.5,
    metalness: 0.0,
    emissive: new THREE.Color(0xdc4d3c),
    emissiveIntensity: 0.8,
    toneMapped: false
  });
  
  const logoMesh = new THREE.Mesh(new THREE.PlaneGeometry(12, 6), logoMat);
  logoMesh.position.set(chamberX, chamberH - 8, northZ - 0.1);
  logoMesh.rotation.y = Math.PI;
  world.add(logoMesh);
  
  // Glowing door frame
  const doorFrame = new THREE.Mesh(new THREE.BoxGeometry(doorW + 0.3, doorH + 0.3, WALL_T), mat.trim);
  doorFrame.position.set(chamberX, doorH/2 + 0.15, northZ);
  world.add(doorFrame);
  
  // Glowing door
  const doorMesh = new THREE.Mesh(
    new THREE.BoxGeometry(doorW, doorH, 0.08),
    new THREE.MeshStandardMaterial({
      color: 0xdc4d3c,
      roughness: 0.4,
      metalness: 0.2,
      emissive: new THREE.Color(0xdc4d3c),
      emissiveIntensity: 0.6,
      toneMapped: false
    })
  );
  doorMesh.position.set(chamberX, doorH/2, northZ - 0.05);
  world.add(doorMesh);
  
  // Neon light
  const neon = new THREE.PointLight(0xdc4d3c, 1.5, 20, 2.0);
  neon.position.set(chamberX, doorH/2, northZ - 1.0);
  scene.add(neon);
  
  // CP trigger at door
  cp.trigger = new THREE.Box3(
    new THREE.Vector3(chamberX - doorW/2 - 0.5, 0, northZ - 1.5),
    new THREE.Vector3(chamberX + doorW/2 + 0.5, chamberH, northZ + 0.5)
  );
  cpGroup.visible = true;
  
  // Teleport player into chamber
  camera.position.set(chamberX, STAND_Y, chamberZ - 15);
  yaw = Math.PI;
  pitch = 0;
  vel.set(0,0,0);
  crouchToggle = false;
  crouchHold = false;
}